<template>
    <div>
        <div class="p-img-add">
            <div style="position: relative">
                <drag-drop tag="ul" class="image-thums im" v-model="imageData">
                    <li :style="imageStyle"
                        v-for="(image, index) in imageData"
                        @dblclick="show_big_pic(image)"
                        :key="index" class="image border-n">
                        <img :title="showBigPic?`双击查看大图`:''"
                             :src="image.path">
                        <div class="tool" v-if="canEdit">
                            <span class="btn-img el-icon-delete" title="删除" @click="remove(index)"></span>
                            <span class="btn-img el-icon-edit" title="修改" @click="mdf_img(index)"></span>
                        </div>
                    </li>
                    <li class="add-image add-image-icon"
                        :style="imageStyle"
                        v-if="imageData.length<maxLength&&canAddImg&&canEdit"
                        @click="add_local"></li>
                </drag-drop>
                <div class="mt-sm red">注意：最多只允许添加 <b>{{maxLength}}</b> 张图片</div>
            </div>
            <input type="file" ref="input" hidden
                   @change="handleChange"
                   :multiple="multiple"
                   accept="image/jpeg,image/jpg,image/png">
            <blowup-image v-model="imgDialog"
                          :img-path="imgPath"
                          :imgArr="imgArr"
                          :showController="true"
                          :title="`查看大图`"></blowup-image>
        </div>
    </div>
</template>
<style lang="stylus" scoped>
    .p-img-add {
        position: relative;
        .image-thums.im {
            border: none;
            display: inline-block;
            position: relative;
        }
        .add-image {
            display: inline-block;
            vertical-align: middle;
            border: 1px dotted #ddd;
            border-radius: 3px;
            transition: all .2s;
            margin: 0 5px 5px 0;
            &:hover {
                transform: scale(1.1);
                box-shadow: 0 0 5px #ccc;
                z-index: 1;
            }
        }
        .image {
            vertical-align: middle;
            border: 1px solid #ddd;
            display: inline-block;
            position: relative;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            transition: all .2s;
            &:hover {
                transform: scale(1.1);
                box-shadow: 0 0 5px #ccc;
                z-index: 1;
            }
            &:hover .tool {
                height: 30px;
            }
            img {
                width: 100%;
                height: 100%;
            }
            .tool {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 0;
                background-color: rgba(0, 0, 0, .5);
                text-align: center;
                overflow: hidden;
                transition: all .3s ease;
                .btn-img {
                    box-sizing: border-box;
                    width: 22px;
                    height: 22px;
                    display: inline-block;
                    color: #fff;
                    font-size: 1.3rem;
                    cursor: pointer;
                    margin: 5px 2px;
                    overflow: hidden;
                    line-height: 22px;
                    &:hover {
                        border-radius: 2px;
                        background-color: rgba(0, 0, 0, .55);
                    }
                    &:active {
                        background-color: rgba(0, 0, 0, .9);
                    }
                    > .i {
                        color: #fff;
                    }
                }
            }
        }
        .border-n {
            margin: 0 5px 5px 0;
        }
    }

</style>
<script>
    import {api_upload_self_goods} from '@/api/goods-image';
    export default {
        data() {
            return {
                showMeitu: false,
                meituUrl: '',
                tempIndex: 0,
                mdfIndex: 0,
                imgDialog: false,
                imgPath: '',
                imageData: this.value,
                editIndex: 0,
                curIndex:'',
                multiple:true,
            }
        },
        methods: {
            /*查看大图*/
            show_big_pic(img){
                this.imgDialog = true;
                this.imgPath = img.path;
            },
            add_local() {
                this.multiple = true;
                setTimeout(() => {
                    this.$refs.input.click();
                }, 200);
            },
            /*处理图片流*/
            handleChange(ev){
                const files = ev.target.files;
                if (!files) {
                    return;
                }
                let fileArr = Array.prototype.slice.call(files);
                let eligibilityArr = fileArr.filter(file=>file.size<=this.maxSize);
                if(eligibilityArr.length<fileArr.length)this.$message({type:'warning',message:'已过滤图片大小超过5M的图片'});
                eligibilityArr.forEach((file,index)=>{
                    file.uid = Date.now() + this.tempIndex++;
                    let  reader = new FileReader();
                    reader.readAsDataURL(file) ;
                    reader.onload =(e)=> {
                        if(this.imageData.length>=this.maxLength&&this.multiple) return;
                        let  imgs = e.target.result;
                        if(this.multiple===false){
                            let obj = this.imageData[this.editIndex];
                            let parm = {
                                id:obj.id,
                                path: imgs,
                                is_update:1,
                            };
                            this.imageData.splice(this.editIndex,1,parm);
                        }else{
                            let parm = {
                                id:0,
                                path: imgs,
                                is_update:1,
                            };
                            this.imageData.push(parm);
                        }

                    }
                });
            },
            mdf_img(index) {
                this.editIndex = index;
                this.multiple = false;
                setTimeout(()=>{
                    this.$refs.input.click();
                },200);
            },
            remove(index) {
                this.imageData.splice(index, 1);
            },
        },
        watch:{
            imageData(val){
                this.$emit('input',val);
            },
            value(val){
                this.imageData = val;
            },
        },
        computed: {
            imageStyle() {
                return {
                    width: this.image.width || 'auto',
                    height: this.image.height || 'auto',
                }
            },
            imgArr(){
                return this.imageData.map(row=>{
                    return {
                        path:row.path
                    }
                })
            }
        },
        props: {
            value:{},
            /*提交图片限制大小*/
            maxSize:{
                type: Number,
                default() {
                    //默认值 5M
                    return 5242880;
                }
            },
            /*添加图片数量的限制*/
            maxLength:{
                type: Number,
                default() {
                    //默认值 5
                    return 5;
                }
            },
            showBigPic: {
                type: Boolean,
                default() {
                    return true;
                }
            },
            image: {//自定义长宽对象
                type: Object,
                default() {
                    return {
                        width: '100px', height: '100px'
                    };
                }
            },
            canEdit: {
                type: Boolean,
                default() {
                    return true;
                }
            },
            canAddImg: {
                type: Boolean,
                default() {
                    return true;
                }
            },
            channelId: {//平台id
                default() {
                    return "";
                }
            },
            spu: {
                default() {
                    return "";
                }
            },
            account: {
                default() {
                    return "";
                }
            }
        },
        components: {
            dragDrop: require('@/components/drag-drop').default,
            blowupImage:require("@/components/blowup-image.vue").default,
        }
    }
</script>
