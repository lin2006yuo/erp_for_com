<template>
    <page-dialog class="p-create-product" :title="dialogTitle"
                 @open="open"
                 v-model="visible" size="large" :close-on-click-modal="false">
        <base-info-copy ref="baseInfo"
                        element-loading-text="数据加载中..."
                        v-loading='loading'
                        :mui-selects="muiSelects"
                        :is-edit="isEdit"
                        :form-data="formData"></base-info-copy>
        <page-log :log-data="logData"
                  v-if="Object.keys(this.curRow).length>0"
                  :logs-loading="logsLoading"></page-log>
        <div slot="footer">
            <div v-if="isEdit" class="inline">
                <el-button type="primary" size="mini" class="inline"
                           v-if="showBtn1"
                           @click.native="save_product('save')">保存</el-button>
                <el-button type="primary" size="mini" class="inline"
                           v-if="showBtn1"
                           @click.native="save_product('toExamine')">提交审核</el-button>
                <el-button type="primary" size="mini" class="inline"
                           v-if="showBtn2"
                           @click.native="examine_adopt">审核通过</el-button>
                <el-button type="primary" size="mini" class="inline"
                           v-if="showBtn2"
                           @click.native="examine_adopt_fail">审核未通过</el-button>
                <el-button type="primary" size="mini" class="inline"
                           v-if="showBtn3"
                           @click.native="to_void">作废</el-button>
                <el-button size="mini" class="inline"
                           v-if="showBtn1"
                           @click.native="visible = false">取消</el-button>
            </div>
            <el-button size="mini" class="inline"
                       v-if="showBtn4||!isEdit"
                       @click.native="visible = false">关闭</el-button>
        </div>
        <little-remark top="553px" right="40px"
                       v-if="addRemark"
                       label="添加原因"
                       @submit="save_reason"
                       @cancel="cancel_reason">
        </little-remark>
    </page-dialog>
</template>
<script>
    import {api_get_categories} from   '../../../api/categories';
    import {publish_edit_plat} from  '@/api/product-library';
    import {api_save_goods,api_get_channel,api_get_detail,api_post_audit,api_get_logs} from '@/api/created-product';
    export default{
        data(){
            return {
                visible:false,
                logData:[],
                formData:{
                    plat:[],
                    category_id:[],
                    dev_platform:'',
                    platform:[],
                    title:'',
                    brand_id:'',

                    tort_id:'',
                    purchase_price:'',
                    lowest_sale_price:'',
                    competitor_price:'',
                    advice_price:'',
                    gross_profit:'',
                    auth_book:[],
                    thumb:[],
                    weight:'',
                    source_url:'',
                    purchase_url:[''],
                    platform_sale:[],
                    description:'',
                    audit:'',
                },
                muiSelects:[],
                addRemark:false,
                curParams:{},
                loading:false,
                logsLoading:false
            }
        },
        mounted(){
            this.init_categories();
        },
        methods:{
            open(){
                /*curRow对象为空时为 创建页面
                *不为空时为 处理页面||查看页面
                * */
                this.addRemark = false;
                if(Object.keys(this.curRow).length<=0){
                    this.empty_space();
                    this.init_platlist();
                }else{
                    this.get_detail();
                    this.get_logs();
                }
            },
            /*创建时置空formData*/
            empty_space(){
                this.formData = {
                    plat:[],
                    category_id:[],
                    dev_platform:'',
                    platform:[],
                    title:'',
                    brand_id:'',
                    tort_id:'',
                    purchase_price:'',
                    lowest_sale_price:'',
                    competitor_price:'',
                    advice_price:'',
                    gross_profit:'',
                    auth_book:[],
                    thumb:[],
                    weight:'',
                    source_url:'',
                    purchase_url:[''],
                    platform_sale:[],
                    description:'',
                    audit:'',
                }
            },
            /*查看&处理 获取详情
            * */
            get_detail(){
                this.loading = true;
                this.$http(api_get_detail,this.curRow.id).then(res=>{
                    this.formData = res;
                    this.formData.platform = this.formData.platform instanceof Array?this.formData.platform:[];
                    this.arrange_auth_book(res);
                    this.get_plat();
                    this.arrange_category();
                    this.arrange_image();
                }).catch(code=>{
                    this.$message({type:'error',message:code.message||code})
                }).finally(()=>{
                    this.loading = false;
                })
            },
            /*查看&处理时
            *整理授权书字段
            * */
            arrange_auth_book(res){
                if(res.auth_book){
                    let imageObj = {
                        image:res.auth_book,
                        name:'查看授权书',
                        path:'',
                    };
                    this.$set(this.formData,'auth_book',[imageObj]);
                }else{
                    this.$set(this.formData,'auth_book',[]);
                }
            },
            /*查看&处理时
            * 获取日志
            * */
            get_logs(){
                this.logsLoading = true;
                this.$http(api_get_logs,this.curRow.id).then(res=>{
                    this.logData = res;
                }).catch(code=>{
                    this.$message({type:'error',message:code.message||code})
                }).finally(()=>{
                    this.logsLoading = false;
                })
            },
            /*查看&处理时
            *整理分类数据
            * */
            arrange_category(){
                if(this.muiSelects){
                    let find = this.muiSelects.find(row=>{
                        return !!row.children.find(val=>val.value===this.formData.category_id);
                    });
                    this.formData.category_id = find?[find.value,this.formData.category_id]:[];
                }
            },
            /*查看&处理时
            * 整理图片
            * */
            arrange_image(){
                this.formData.thumb = this.formData.thumb.map(row=>{
                    this.$set(row,'is_update',0);
                    return row;
                });
            },
            /*创建时使用，获取平台*/
            get_chennel(){
                return this.$http(api_get_channel).then(res=>{
                    return Promise.resolve(res)
                })
            },
            /*创建时使用，获取平台状态*/
            init_platlist(){
                this.get_chennel().then(res=>{
                    this.formData.platform_sale = res.map(row=>{
                        return {
                            name:row.title,
                            id:row.id,
                            value:'可选上架',
                            value_id:1
                        }
                    });
                })
                this.get_plat();
            },
            /*获取 销售平台状态
            * */
            get_plat(){
                this.$http(publish_edit_plat).then(res=>{
                    this.$set(this.formData,'plat',res);
                }).catch(code=>{
                    console.log(code,'code');
                })
            },
            edit_product(){
                this.visible = false;
                this.$emit('edit-product')
            },
            add_good(val,id){
                this.visible = false;
                this.$emit('update-product',val,id)
            },
            /*验证是否可以保存*/
            validate_form(){
                if(this.formData.category_id.length<=0)return this.tip_message('分类');
                if(!this.formData.dev_platform)return this.tip_message('开发平台');
                if(!this.formData.title)return this.tip_message('产品标题');
                if(this.formData.thumb.length<=0)return this.tip_message('产品图片');
                if(!this.formData.brand_id)return this.tip_message('品牌');
                if(!this.formData.purchase_price)return this.tip_message('采购价');
                if(!this.formData.advice_price)return this.tip_message('建议售价');
                if(!this.formData.gross_profit)return this.tip_message('本平台预估毛利率');
                if(!this.formData.weight)return this.tip_message('产品毛重');
                return true;
            },
            tip_message(name){
                this.$message({type:'warning',message:`【${name}】为必填项,请补充完整!`});
                return false;
            },
            /*整理formData数据*/
            arrange_form(curHandle){
                let cloneData = clone(this.formData);
                delete cloneData.auth_book; //先删掉授权文件字段，然后根据条件判断加还是不加
                cloneData.category_id = cloneData.category_id[1];
                cloneData.platform_sale = JSON.stringify(cloneData.platform_sale);
                cloneData.thumb = JSON.stringify(cloneData.thumb.map(row=>{
                    return {
                        id:row.hasOwnProperty('id')?row.id:0,
                        path:row.path,
                        is_update:row.hasOwnProperty('is_update')?row.is_update:1,
                    }
                }));
                if(!this.formData.auth_book||this.formData.auth_book.length<=0){
                    cloneData.auth_book = '';
                }else{ //编辑的时候判断是新添加的，就上传，没有变动就不传这个字段
                    let path = this.formData.auth_book[0];
                    if(path.path.includes('blob:')){
                        cloneData.auth_book = path.image
                    }
                }
                switch(curHandle){
                    case 'save':
                        this.$set(cloneData,'audit',0);
                        break;
                    case 'toExamine':
                        this.$set(cloneData,'audit',1);
                        break;
                }
                return cloneData
            },
            /*
            * 保存&提交审核
            * */
            save_product(curHandle){
                if(!this.validate_form())return;
                let data = this.arrange_form(curHandle);
                this.$http(api_save_goods,data).then(res=>{
                    this.$message({type:'success',message:res.message||res});
                    this.visible = false;
                    this.$emit('init-row',res.data);
                }).catch(code=>{
                    this.$message({type:'error',message:code.message||code});
                })
            },
            /*初始分类
            * */
            init_categories(){
                let get_child_ids=(child_ids,data)=>{
                    let childList = child_ids.map(row=>{
                        return data[row]
                    });
                    childList = childList.map(row=>{
                        let dataobj = {
                            value:row.id,
                            label:row.title?row.title:row.name,
                        };
                        if(row.child_ids&&row.child_ids.length>0){
                            this.$set(dataobj,'children',get_child_ids(row.child_ids,data));
                        }
                        return dataobj
                    });
                    return childList;
                };
                this.$http(api_get_categories).then(data=>{
                    let plist = Object.values(data).filter(row=>row.pid===0);
                    plist = plist.map(row=>{
                        let dataObj = {
                            label:row.title?row.title:row.name,
                            value:row.id,
                        };
                        if(row.child_ids&&row.child_ids.length>0){
                            this.$set(dataObj,'children',get_child_ids(row.child_ids,data));
                        }
                        return dataObj
                    });
                    this.muiSelects = plist;
                }).catch(code=>{
                    this.$message({
                        type:"error",
                        message:code.message || code
                    })
                });
            },
            /*
            * 审核通过
            * submit 提交
              cancel 作废
              kf_audit_success  开发主管审核通过
              kf_audit_fail    开发主管审核未通过
              sku_audit_success  sku查重通过
              sku_audit_fail   sku查重不通过
            * */
            examine_adopt(){
                let data = {
                    id:this.formData.id,
                    remark:'ceshi',
                    code:this.get_cur_code(false)
                };
                this.audit_api(data);
            },
            /*审核不通过*/
            examine_adopt_fail(){
                this.addRemark = true;
                this.curParams = {
                        id:this.formData.id,
                        code:this.get_cur_code(true)
                    };
            },
            get_cur_code(isFail){
                //isFail参数判断是否为审核不通过按钮
                switch(this.formData.process_id){
                    case 1://未提交
                        return '';
                    case 16://待开发主管审核
                        return isFail?'kf_audit_fail':'kf_audit_success';
                    case 17://开发主管审核未通过
                        return '';
                    case 112://待sku查重
                        return isFail?'sku_audit_fail':'sku_audit_success';
                    case 113://sku查重不通过
                        return '';
                    case 496://预开发完成
                        return '';
                    case -1://作废
                        return '';
                    default:
                        return ''
                }
            },
            /*
            * 作废
            * */
            to_void(){
                this.addRemark = true;
                this.curParams = {
                    id:this.formData.id,
                    code:'cancel',
                };
            },
            /*审核接口*/
            audit_api(data){
                this.$http(api_post_audit,data).then(res=>{
                    this.$message({
                        type:"success",
                        message:res.message || res
                    });
                    this.visible = false;
                    this.$emit('init-row',res.data);
                }).catch(code=>{
                    this.$message({
                        type:"error",
                        message:code.message || code
                    })
                })
            },
            save_reason(note){
                if(note==='')return this.$message({type:"error",message:'请添加原因后再点击提交！'});
                this.$set(this.curParams,'remark',note);
                this.addRemark = false;
                this.audit_api(this.curParams);
            },
            cancel_reason(){
                this.addRemark = false;
            },
        },
        computed:{
            dialogTitle(){
                let title = '创建';
                if(this.isEdit&&Object.keys(this.curRow).length>0){
                    title = `处理流程编号：${this.curRow.code} 信息`;
                }else if(!this.isEdit&&Object.keys(this.curRow).length>0){
                    title = `查看流程编号：${this.curRow.code} 信息`;
                }
                return title;
            },
            /*新创建/未提交/开发主管审核未通过/sku查重不通过 页面显示的操作按钮
            * */
            showBtn1(){
                return (this.curRow&&(this.curRow.process_id===1||this.curRow.process_id===17||this.curRow.process_id===113||this.curRow.process_id===1))||Object.keys(this.curRow).length<=0;
            },
            /*待开发主管审核/待sku查重 页面显示的操作按钮
            * */
            showBtn2(){
                return this.curRow&&(this.curRow.process_id===16||this.curRow.process_id===112)
            },
            /*开发主管审核未通过/sku查重未通过 页面显示的操作按钮
            * */
            showBtn3(){
                return this.curRow&&(this.curRow.process_id===1||this.curRow.process_id===17||this.curRow.process_id===113)
            },
            /*待开发主管审核/待sku查重/预开发完成/作废 页面显示的操作按钮
            * */
            showBtn4(){
                return this.curRow&&(this.curRow.process_id===16||this.curRow.process_id===112||this.curRow.process_id===496||this.curRow.process_id===-1)
            },

        },
        watch: {
            visible(val){
                this.$emit('input', val);
            },
            value(val){
                this.visible = val;
            }
        },
        props: {
            /*弹框开关
            * */
            value: {},
            /*查看和处理的区分：true页面可以编辑;false页面不可编辑
            * */
            isEdit: {},
            /*当前数据的状态，判断弹框按钮的显示
            * 创建&未提交-》显示-》保存/提交审核/取消 & 页面可编辑
            * 待开发主管审核状态-》显示-》审核通过/审核未通过/关闭 & 页面不可编辑
            * 开发主管审核未通过-》显示-》保存/提交审核/作废/取消 & 页面可编辑
            * 待SKU查看-》显示-》审核通过/审核未通过/关闭 & 页面不可编辑
            * SKU查重未通过-》显示-》保存/提交审核/作废/取消 &页面可编辑
            * 预开发完成-》显示-》关闭 & 页面不可编辑
            * 作废-》显示-》关闭 &页面不可编辑
            * */
            curStatus:{
                type:String,
            },
            /*正在操作的当前行的数据
            * */
            curRow:{},
        },
        components: {
            baseInfo: require('./base-info.vue').default,
            pageDialog: require("../../../components/page-dialog.vue").default,
            baseInfoCopy: require('./base-info-copy.vue').default,
            littleRemark:require('@/components/little-remark').default,
            pageLog:require('./page-log').default,
        }
    }
</script>

