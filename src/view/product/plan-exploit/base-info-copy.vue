<template>
    <div class="c-base-info-copy">
        <el-form :model="formData" label-width="180px">
            <el-form-item label="分类：" required>
                <el-cascader
                        v-if="canEdit"
                        v-model="formData.category_id"
                        placeholder="输入搜索"
                        :options="muiSelects"
                        filterable></el-cascader>
                <div v-else>{{comCategory}}</div>
            </el-form-item>
            <el-form-item label="开发平台：" required>
                <!--<el-select v-model="formData.dev_platform"-->
                           <!--v-if="canEdit"-->
                           <!--class="inline s-width-large"-->
                           <!--default-first-option-->
                           <!--filterable clearable>-->
                    <!--<el-option-->
                        <!--v-for="res in platformList"-->
                        <!--:label="res.label"-->
                        <!--:value="res.name"-->
                        <!--:key="res.name"-->
                    <!--&gt;</el-option>-->
                <!--</el-select>-->
                <super-select v-model="formData.dev_platform"
                              class="inline s-width-large"
                              storageKey="channelList"
                              :options="platformList"
                              v-if="canEdit"></super-select>
                <div v-else>{{comPlat}}</div>
            </el-form-item>
            <el-form-item label="平台分类：">
                <el-row v-for="(item,index) in formData.platform" :key="index">
                    <span>{{item.label}}</span>
                    <el-button type="primary" size="mini" class="inline"
                               v-if="canEdit"
                               @click.native="edit_platform(item,index)">编辑</el-button>
                    <el-button type="danger" size="mini" class="inline"
                               v-if="canEdit"
                               @click.native="delete_platform(index)">删除</el-button>
                </el-row>
                <el-button type="primary" size="mini" class="inline"
                           v-if="canEdit"
                           @click.native="add_platform">添加平台分类</el-button>
            </el-form-item>
            <el-form-item label="产品标题：" required>
                <el-input v-model="formData.title"
                          v-if="canEdit"
                          class="base-info-width"></el-input>
                <div v-else>{{formData.title}}</div>
            </el-form-item>
            <el-form-item label="产品图片：" required>
                <add-local-image v-model="formData.thumb"
                                 :can-edit="canEdit"></add-local-image>
            </el-form-item>
            <el-form-item label="品牌：" required>
                <!--<el-select class="inline"-->
                           <!--placeholder="输入搜索更多"-->
                           <!--ref="brand" filterable clearable default-first-option-->
                           <!--remote :remote-method="remoteMethod"-->
                           <!--v-model="formData.brand_id"-->
                           <!--v-if="canEdit">-->
                    <!--<el-option v-for="brand in brandOption"-->
                               <!--:key="brand.id" :label="brand.name"-->
                               <!--:value="brand.id"></el-option>-->
                <!--</el-select>-->
                <super-select class="inline" v-model="formData.brand_id" v-if="canEdit"
                              storageKey="brandList" :options="brandList"></super-select>
                <el-button type="primary"
                           size="mini"
                           v-if="canEdit"
                           @click.native="add_brand"
                           class="inline">新增品牌</el-button>
                <div class='inline' v-if="!canEdit">{{comBrand}}</div>
                <!--auth_book 没有值时-->
                <upload-img class='inline' v-if="formData.brand_id"
                            :images="formData.auth_book"
                            :edit="canEdit">
                </upload-img>
                <!--<span :class="[formData.auth_book?'auth-book-red':'auth-book-default','auth-book','operate']" >{{formData.auth_book?'查看授权书':'上传授权书'}}</span>-->
            </el-form-item>
            <el-form-item label="产品侵权风险：">
                <el-select v-model="formData.tort_id"
                           v-if="canEdit"
                           class="inline s-width-large"
                           default-first-option
                           filterable clearable>
                    <el-option
                            v-for="res in tortList"
                            :label="res.name"
                            :value="res.id"
                            :key="res.id"
                    ></el-option>
                </el-select>
                <div v-else>{{comTort}}</div>
            </el-form-item>
            <el-row>
                <el-col :span="8">
                    <el-form-item label="采购价（CNY）：" required>
                        <el-input v-model="formData.purchase_price" v-if="canEdit"></el-input>
                        <div v-else>{{formData.purchase_price}}</div>
                    </el-form-item>
                </el-col>
                <el-col :span="8">
                    <el-form-item label="最低限价（CNY）：">
                        <el-input v-model="formData.lowest_sale_price" v-if="canEdit"></el-input>
                        <div v-else>{{formData.lowest_sale_price}}</div>
                    </el-form-item>
                </el-col>
            </el-row>
            <el-row>
                <el-col :span="8">
                    <el-form-item label="建议售价（USD）：" required>
                        <el-input v-model="formData.advice_price" v-if="canEdit"></el-input>
                        <div v-else>{{formData.advice_price}}</div>
                    </el-form-item>
                </el-col>
                <el-col :span="8">
                    <el-form-item label="竞争对手售价（USD）：">
                        <el-input v-model="formData.competitor_price" v-if="canEdit"></el-input>
                        <div v-else>{{formData.competitor_price}}</div>
                    </el-form-item>
                </el-col>
            </el-row>
            <el-form-item label="本平台预估毛利率：" required>
                <el-input v-model="formData.gross_profit"
                          v-if="canEdit"
                          class='s-width-large inline'></el-input>
                <span v-else>{{formData.gross_profit}}</span>
                %
            </el-form-item>
            <el-form-item label="产品毛重：" required>
                <el-input v-model="formData.weight"
                          v-if="canEdit"
                          class='s-width-large inline'></el-input>
                <span v-else>{{formData.weight}}</span> g
            </el-form-item>
            <el-form-item label="平台连接：">
                <div class="base-info-width" v-if="canEdit">
                    <el-input style="width:80%;display: inline-block"
                              v-model="formData.source_url"></el-input>
                    <el-button type="primary" size="mini"
                               @click.native="open_url(formData.source_url)">打开平台链接</el-button>
                </div>
                <div v-else>{{formData.source_url}}</div>
            </el-form-item>
            <el-form-item label="采购链接：">
                <div v-if="canEdit"
                     v-for="(row,index) in formData.purchase_url"
                     class="base-info-width mb-mini">
                    <el-input style="width:80%;display: inline-block"
                              v-model="formData.purchase_url[index]"></el-input>
                        <el-button type="primary" size="mini"
                                   v-show="index===formData.purchase_url.length-1"
                                   @click.native="add_url">添加</el-button>
                        <el-button size="mini" type="success"
                                   :disabled="!formData.purchase_url[index]"
                                   @click="open_url(formData.purchase_url[index])">打开链接</el-button>
                        <el-button size="mini" type="danger"
                                   v-show="formData.purchase_url.length>1&&index!==formData.purchase_url.length-1"
                                   @click="del_link(index)">删除</el-button>
                </div>
                <div v-if="!canEdit" v-for="item in formData.purchase_url">{{item}}</div>
            </el-form-item>
            <el-form-item label="销售平台状态：" required>
                <platform-sale :platform-data="formData.platform_sale"
                               :colNumber="3" v-if="formData.plat"
                               :plat="formData.plat" :editAble="canEdit"></platform-sale>
            </el-form-item>
            <el-form-item label="产品描述：">
                <el-input type="textarea" v-if="canEdit"
                          v-model="formData.description"
                          class="base-info-width"></el-input>
                <div v-else>{{formData.description}}</div>
            </el-form-item>
        </el-form>
        <add-classify v-model="addClassify"
                      @getclass="mdf_classify"
                      ref="classify"></add-classify>
        <add-brand v-model="brandDialog"
                   :is-edit="true"
                   @reload="reload_brand"
                   :brand-form="brandForm"></add-brand>
    </div>
</template>
<style lang="stylus">
    .c-base-info-copy{
        .base-info-width{
            width:75%;
            display: inline-block;
        }
        .auth-book {
            padding-left: 19px;
            display: inline-block;
            &.auth-book-default {
                background: url('../../../assets/pin.svg') left center no-repeat;
                background-size: contain;
            }
            &.auth-book-red {
                background: url('../../../assets/pin-red.svg') left center no-repeat;
                background-size: contain;
            }
        }
    }
</style>
<script>
    import {api_get_channel} from '@/api/order-local';
    import {publish_edit_tort,publish_edit_brand}from '@/api/product-library';
    export default{
        data(){
            return{
                editAble:true,
                platformList:[],
                brandList:[],
                brandOption:[],
                tortList:[],
                addClassify:false,
                isAddPlatform:false,
                brandDialog:false,
                classify_index:0,
                /*品牌*/
                brandForm:{
                    name:'',
                    code:'',
                    logo:'',
                    site_url:'',
                    description:''
                },
            }
        },
        mounted(){
            this.get_channel();
            this.get_tort();
            this.get_brand().then(res=>{
                this.brandOption = this.slice_list(res,50)
            });
        },
        methods:{
            add_brand(){
                this.brandDialog = true;
                this.brandForm = {
                    name:'',
                    code:'',
                    logo:'',
                    site_url:'',
                    description:''
                }
            },
            reload_brand(id,form){
                this.get_brand().then(res=>{
                    let find = res.find(val=>form.name === val.name);
                    if(find)this.formData.brand_id = find.id
                });
            },
            get_brand(){
                return this.$http(publish_edit_brand).then(res=>{
                    this.brandList = res.map(row=>{
                        return {
                            label:row.name,
                            value:row.id
                        }
                    });
                    return Promise.resolve(res);
                }).catch(code=>{
                    this.$message({
                        type:'error',
                        message:code.message||code
                    });
                })
            },
            mdf_classify(mdf){
                let length=mdf.length;
                let label = mdf.map(lable=>lable.label);
                let data = {
                    label: label.join(">>"),
                    path: JSON.stringify(mdf),
                    channel_id: mdf[0].id,
                    channel_category_id: mdf[length-1].id
                };
                if(mdf[1].code){
                    data.site_id=mdf[1].id;
                }else {
                    data.site_id=0;
                }
                if (this.isAddPlatform) {
                    this.formData.platform.push(data);
                }else {
                    this.formData.platform.splice(this.classify_index,1,data);
                }
            },
            /*
            *处理品牌数据，品牌数据量大，所以需要这种处理方式
            * */
            remoteMethod(query) {
                if (query !== '') {
                    setTimeout(() => {
                        this.brandOption = this.brandList.filter(item => {
                            if(typeof query === 'number'){
                                return item.id === query
                            }else{
                                return item.name.toLowerCase()
                                    .indexOf(query.toLowerCase()) > -1;
                            }
                        });
                    }, 200);
                } else {
                    this.brandOption = this.slice_list(this.brandList,50)
                }
            },
            /*截取brandList
            * */
            slice_list(list,num){
                return (list&&list.length>num)?list.slice(1,num):list;
            },
            /*平台分类*/
            add_platform(){//添加
                this.isAddPlatform=true;
                this.addClassify = true;
                this.$refs.classify.isAdd=true;
                this.$refs.classify.plat = [];
                this.$nextTick(() => {
                    this.$refs.classify.req = []
                });
            },
            edit_platform(item,index){//编辑
                this.isAddPlatform=false;
                this.classify_index=index;
                this.$refs.classify.index=index;
                this.$refs.classify.plat=this.formData.platform;
                this.$refs.classify.isAdd=false;
                if (item.path && item.path !== "") {
                    this.$refs.classify.req = JSON.parse(item.path);
                } else {
                    this.$refs.classify.req = [];
                }
                this.addClassify = true;
                this.$nextTick(()=>{
                    this.$refs.classify.$refs.addclass.edit()
                })
            },
            delete_platform(index){ //删除
                this.formData.platform.splice(index,1);
            },

            /*采购链接*/
            open_link(index){
                let url = this.formData.purchase_url[index];
                window.open(url);
            },
            open_url(urlData){
                let url =  urlData.includes('http')?urlData:'http://'+urlData;
                window.open(url);
            },
            del_link(index){
                this.formData.purchase_url.splice(index,1);
            },
            add_url(){
                this.formData.purchase_url.push('');
            },
            fix_result(val){
                return val.map(row=>{
                    return {
                        label:row.name,
                        value:row.id
                    }
                })
            },
            /*API 请求区
            * */
            get_channel(){
                this.$http(api_get_channel).then(res => {
                    this.platformList = res.map(row=>{
                        return {
                            label:row.label,
                            value:row.name
                        }
                    });
                }).catch(code => {
                    this.$message({type:'error',message:code.message||code});
                })
            },
            get_tort(){
                this.$http(publish_edit_tort).then(res => {
                    this.tortList = res;
                }).catch(code => {
                    console.log(code,'code');
                });
            }
        },
        computed:{
            canEdit(){
                return this.formData&&(this.formData.process_id===16||this.formData.process_id===112)||!this.isEdit?false:true
            },
            comCategory(){
                let str = '暂无数据';
                if(this.muiSelects&&this.formData&&this.formData.category_id&&this.formData.category_id.length===2){
                    let find_first = this.muiSelects.find(row=>row.value===this.formData.category_id[0]);
                    if(find_first){
                        str = find_first.label;
                        let find_Send = find_first.children.find(val=>val.value===this.formData.category_id[1])
                        if(find_Send){
                            str = `${str}/${find_Send.label}`
                        }
                    }
                }
                return str
            },
            comPlat(){
                let label='暂无数据';
                if(this.platformList&&this.formData){
                    let find = this.platformList.find(row=>row.value===this.formData.dev_platform);
                    if(find){
                        label = find.label
                    }
                }
                return label;
            },
            comTort(){
                let label = '暂无数据';
                if(this.tortList&&this.formData){
                    let find = this.tortList.find(row=>row.id===this.formData.tort_id)
                    if(find){
                        label = find.name;
                    }
                }
                return label;
            },
            comBrand(){
                let label = '暂无数据';
                if(this.brandList&&this.formData){
                    let find = this.brandList.find(row=>row.value===this.formData.brand_id);
                    if(find){
                        label = find.label;
                    }
                }
                return label
            },
        },
        props:{
            formData:{
                type:Object,
                required:true
            },
            muiSelects:{
                type:Array,
                required:true
            },
            isEdit:{
                type:Boolean,
                required:true
            }
        },
        components:{
            paramAccount:require('@/api-components/param-account.vue').default,
            addLocalImage:require('./add-local-image.vue').default,
            addClassify: require("../classify/add-classify.vue").default,
            addBrand:require('../brand/add-brand').default,
            platformSale:require('../platform-sale').default,
            uploadImg:require('@/components/upload-img.vue').default,
        }
    }
</script>
