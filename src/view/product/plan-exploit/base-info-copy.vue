<template>
    <div class="c-base-info-copy">
        <el-form :model="formData" label-width="180px">
            <el-form-item label="分类：" required>
                <el-cascader
                        v-model="formData.category_id"
                        placeholder="输入搜索"
                        :options="muiSelects"
                        filterable></el-cascader>
            </el-form-item>
            <el-form-item label="开发平台：" required>
                <el-select v-model="formData.dev_platform"
                           class="inline s-width-large"
                           default-first-option
                           filterable clearable>
                    <el-option
                        v-for="res in platformList"
                        :label="res.label"
                        :value="res.value"
                        :key="res.value"
                    ></el-option>   
                </el-select>   
            </el-form-item>
            <el-form-item label="平台分类：">

            </el-form-item>
            <el-form-item label="产品标题：" required>
                <el-input v-model="formData.title" class="base-info-width"></el-input>
            </el-form-item>
            <el-form-item label="产品图片：" required>
                <add-local-image v-model="formData.thumb"></add-local-image>
            </el-form-item>
            <el-form-item label="品牌：" required>
                <param-account v-model="formData.brand_id"
                               :fix-result="fix_result"
                               url="get|brand/dictionary"
                               type="productBrand"></param-account>
                <el-button type="primary"
                           size="mini"
                           class="inline">新增品牌</el-button>
                <el-button type="text"
                           size="mini"
                           class="inline">上传授权书</el-button>
            </el-form-item>
            <el-form-item label="产品侵权风险：">
                <el-select v-model="formData.tort_id"
                           class="inline s-width-large"
                           default-first-option
                           filterable clearable>
                    <el-option
                            v-for="res in tortList"
                            :label="res.name"
                            :value="res.id"
                            :key="res.id"
                    ></el-option>
                </el-select>
            </el-form-item>
            <el-row>
                <el-col :span="8">
                    <el-form-item label="采购价（CNY）：" required>
                        <el-input v-model="formData.purchase_price"></el-input>
                    </el-form-item>
                </el-col>
                <el-col :span="8">
                    <el-form-item label="最低限价（CNY）：">
                        <el-input v-model="formData.lowest_sale_price"></el-input>
                    </el-form-item>
                </el-col>
            </el-row>
            <el-row>
                <el-col :span="8">
                    <el-form-item label="建议售价（USD）：" required>
                        <el-input v-model="formData.advice_price"></el-input>
                    </el-form-item>
                </el-col>
                <el-col :span="8">
                    <el-form-item label="竞争对手售价（USD）：">
                        <el-input v-model="formData.competitor_price"></el-input>
                    </el-form-item>
                </el-col>
            </el-row>
            <el-form-item label="本平台预估毛利率：">
                <el-input v-model="formData.gross_profit" class='s-width-large inline'></el-input> %
            </el-form-item>
            <el-form-item label="产品毛重：" required>
                <el-input v-model="formData.weight" class='s-width-large inline'></el-input> g
            </el-form-item>
            <el-form-item label="平台连接：">
                <div class="base-info-width">
                    <el-input style="width:80%;display: inline-block"
                              v-model="formData.source_url"></el-input>
                    <el-button type="primary" size="mini"
                               @click.native="open_url">打开平台链接</el-button>
                </div>
            </el-form-item>
            <el-form-item label="采购链接：">
                <div v-for="(row,index) in formData.purchase_url"
                     class="base-info-width mb-mini">
                    <el-input style="width:80%;display: inline-block"
                              v-model="formData.purchase_url[index]"></el-input>
                    <!--<div style="width:20%;display: inline-block">-->
                        <el-button size="mini" type="success"
                                   :disabled="!formData.purchase_url[index]"
                                   @click="open_link(index)">打开链接</el-button>
                        <el-button size="mini" type="danger"
                                   v-show="formData.purchase_url.length>1&&index!==formData.purchase_url.length-1"
                                   @click="del_link(index)">删除</el-button>
                        <el-button type="primary" size="mini"
                                   v-show="index===formData.purchase_url.length-1"
                                   @click.native="add_url">添加</el-button>
                    <!--</div>-->
                </div>
            </el-form-item>
            <el-form-item label="销售平台状态：">

            </el-form-item>
            <el-form-item label="产品描述：">
                <el-input type="textarea"
                          v-model="formData.description"
                          class="base-info-width"></el-input>
            </el-form-item>
        </el-form>
    </div>
</template>
<style lang="stylus">
    .base-info-width{
        width:75%;
        display: inline-block;
    }
</style>
<script>
    import {api_get_categories} from   '../../../api/categories';
    import {api_get_channel} from '@/api/order-local';
    import {publish_edit_tort}from '@/api/product-library';
    export default{
        data(){
            return{
                muiSelects:[],
                platformList:[],
                brandList:[],
                tortList:[],
                formData:{
                    category_id:[],
                    dev_platform:[],
                    title:'',
                    brand_id:'',
                    tort_id:'',
                    purchase_price:'',
                    lowest_sale_price:'',
                    competitor_price:'',
                    advice_price:'',
                    gross_profit:'',
                    auth_book:'',
                    thumb:[],
                    weight:'',
                    source_url:'',
                    purchase_url:[''],
                    platform_sale:'',
                    description:'',
                    audit:'',
                }
            }
        },
        mounted(){
            this.init_categories();
            this.get_channel();
            this.get_tort();
        },
        methods:{
            open_link(index){
                let url = this.formData.purchase_url[index];
                console.log(url,'url');
            },
            open_url(){
                console.log('打开链接',this.formData.source_url);
            },
            del_link(index){
                this.formData.purchase_url.splice(index,1);
            },
            add_url(){
                this.formData.purchase_url.push('');
            },
            fix_result(val){
                return val.map(row=>{
                    return {
                        label:row.name,
                        value:row.id
                    }
                })
            },
            /*API 请求区
            * */
            init_categories(){
                let get_child_ids=(child_ids,data)=>{
                    let childList = child_ids.map(row=>{
                        return data[row]
                    });
                    childList = childList.map(row=>{
                        let dataobj = {
                            value:row.id,
                            label:row.title?row.title:row.name,
                        };
                        if(row.child_ids&&row.child_ids.length>0){
                            this.$set(dataobj,'children',get_child_ids(row.child_ids,data));
                        }
                        return dataobj
                    });
                    return childList;
                };
                this.$http(api_get_categories).then(data=>{
                    let plist = Object.values(data).filter(row=>row.pid===0);
                    plist = plist.map(row=>{
                        let dataObj = {
                            label:row.title?row.title:row.name,
                            value:row.id,
                        };
                        if(row.child_ids&&row.child_ids.length>0){
                            this.$set(dataObj,'children',get_child_ids(row.child_ids,data));
                        }
                        return dataObj
                    });
                    this.muiSelects = plist;
                }).catch(code=>{
                    this.$message({
                        type:"error",
                        message:code.message || code
                    })
                });
            },
            get_channel(){
                this.$http(api_get_channel).then(res => {
                    this.platformList = res;
                }).catch(code => {
                    this.$message({type:'error',message:code.message||code});
                })
            },
            get_tort(){
                this.$http(publish_edit_tort).then(res => {
                    this.tortList = res;
                }).catch(code => {
                    console.log(code,'code');
                });
            }
        },
        props:{

        },
        components:{
            paramAccount:require('@/api-components/param-account.vue').default,
            addLocalImage:require('./add-local-image.vue').default,
        }
    }
</script>