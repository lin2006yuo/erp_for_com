<template>
    <page class="p-plan-exploit">
        <search-data :search-data="searchData"
                     @click-button="click_button"
                     :clears="clears"
                     @search="init"></search-data>
        <div class="mt-xs mb-xs ml-sm">
            <el-button type="primary" size="mini" @click="create_product">创建</el-button>
            <el-button type="primary" size="mini" disabled>批量导出</el-button>
        </div>
        <table-data :table-data="tableData"
                    @read-goods="look_over"
                    @dispose-goods="dispose_goods"
                    @size-change="size_change"
                    @current-change="current_change"
                    :loading="loading"></table-data>
        <create-sku-product v-model="createSkuVisible"
                            :cur-row="curRow"
                            @init-row="init_row"
                            :is-edit="isEdit">
        </create-sku-product>
    </page>
</template>
<script>
    import {
        api_get_goods,
        api_goods_log,
        api_goods_process,
        api_read_good,
        api_proposer,
        api_product_person,
        api_get_goods_pre_dev_audit
    } from '../../../api/plan-exploit'
    export default{
        page: {},
        refresh(){
            this.init();
        },
        data(){
            return {
                searchData: {
                    process_id: 0,
                    create_id: '',
                    search_key: 'code',
                    search_val: '',
                    create_time_start: '',
                    create_time_end: ''
                },
                clears:{
                    search_key: 'code',
                },
                tableData:{
                    lists:[],
                    page:1,
                    pageSize:50,
                    count:0,
                },
                loading: false,
                createSkuVisible: false,
                curRow:{},
                isEdit: true,
            }
        },
        mounted(){
            this.init();
        },
        methods: {
            /*切换开发流程按钮
            * */
            click_button(){
                this.init();
            },
            /*初始数据
            * */
            init(){
                this.loading = true;
                let data = clone(this.data_format());
                this.$set(data,'page',this.tableData.page);
                this.$set(data,'pageSize',this.tableData.pageSize);
                this.$http(api_get_goods, data).then(res => {
                    this.tableData.lists = res.data;
                    this.tableData.count = res.count;
                }).catch(code => {
                    this.$message({type:'error',message:code.message||code});
                }).finally(()=>{
                    this.loading = false;
                })
            },
            /*日期整理
            * */
            data_format(){
                let start =  this.searchData.create_time_start;
                let end = this.searchData.create_time_end;
                this.searchData.create_time_start = start?datef("YYYY-MM-dd", new Date(start)/1000):'';
                this.searchData.create_time_end = end?datef("YYYY-MM-dd", new Date(end)/1000):'';
                return this.searchData;
            },
            /*创建
            * */
            create_product(){
                this.createSkuVisible = true;
                this.curRow = {};
                this.isEdit = true;
            },
            /*查看
            * */
            look_over(row){
                this.isEdit = false;
                this.curRow = row;
                this.createSkuVisible = true;
            },
            /*处理
            * */
            dispose_goods(row){
                this.isEdit = true;
                this.curRow = row;
                this.createSkuVisible = true;
            },
            size_change(val){
                this.tableData.pageSize = val;
                this.init();
            },
            current_change(val){
                this.tableData.page = val;
                this.init();
            },
            /*详情-》用于刷新列表数据
            * */
            init_row(data){
                if(this.searchData.process_id===0||this.searchData.process_id===data.process_id){
                    this.process_data(data);
                }else{
                    let index = this.tableData.lists.findIndex(res=>Number(res.id)===Number(data.id));
                    if(index>-1)this.tableData.lists.splice(index,1);
                    this.tableData.count--;
                }
            },
            /*用于封装刷新列表的数据*/
            process_data(data){
                let index = this.tableData.lists.findIndex(res=>Number(res.id)===Number(data.id));
                if(index>-1){
                    this.tableData.lists.splice(index,1,data);
                }else{
                    this.tableData.lists.unshift(data);
                    this.tableData.count++;
                }
            },


        },
        components: {
            createSkuProduct: require("./create-sku-product.vue").default,
            tableData:require('./table-data.vue').default,
            searchData:require('./search-data.vue').default,
        }
    }
</script>

